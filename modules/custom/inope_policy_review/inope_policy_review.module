<?php
/**
 * @file
 * The iNope Policy Review Module.
 */

/**
 * Implements hook_menu().
 */
function inope_policy_review_menu() {
  $items = array();

  $items['node/%node/review'] = array(
    'title callback' => 'inope_policy_review_tab_title_callback',
    'title arguments' => array(1),
    'description' => 'Review of policy nodes.',
    'page callback' => 'inope_policy_review_page',
    'page arguments' => array(1),
    'access arguments' => array('view inope policy review'),
    'type' => MENU_LOCAL_TASK,
  );

  return $items;
}

/**
 * Creates the iNope policy review page title.
 *
 * The page title will be 'Review of @node_title' where @node_title is replaced
 * by the title of the object returned from node_load().
 *
 * @param object $node
 *   Object representing the current node passed from hook_menu.
 *
 * @return string
 *   String of characters to be used as the title in a menu local task for
 *   policy nodes.
 */
function inope_policy_review_tab_title_callback($node) {
  // Create the string to be used as the tab title.
  $title = t('Review of @node_title', array('@node_title' => $node->title));
  return $title;
}

/**
 * Creates the iNope policy review page.
 *
 * The page will call drupal_get_form() to load the inope_policy_review_form.
 *
 * @param object $node
 *   Object representing the current node passed from hook_menu.
 *
 * @return string
 *   String of characters to be used as the title in a menu local task for
 *   policy nodes.
 */
function inope_policy_review_page($node) {
  // Create a build array to be displayed on the page.
  $build = array(
    'inope_policy_review_form' => drupal_get_form('inope_policy_review_form', $node),
  );
  return $build;
}

/**
 * Implements hook_permission().
 */
function inope_policy_review_permission() {
  return array(
    'view inope policy review' => array(
      'title' => t('View iNope Policy Review'),
      'description' => t('View the review tab on policy node pages'),
    ),
  );
}

/**
 * Implements hook_form_alter().
 */
function inope_policy_review_form_alter(&$form, &$form_state, $form_id) {

  global $user;
  $account = $user;

  // Store argument from the autoloader in hook_menu().
  $node = $form_state['build_info']['args'][0];

  // Check that we are only altering the inope policy review form.
  if ($form_id == 'inope_policy_review_form') {

    // Query the policy review table for any records related to the current
    // node, unapproved notes, and are from the current user.
    $results = db_select('policy_review', 'pr')
      ->fields('pr')
      ->condition('nid', $node->nid, '=')
      ->condition('note_status', 0, '=')
      ->condition('uid', $account->uid, '=')
      ->execute()
      ->fetchAssoc();

    // If the active user has submitted something and is not an administrator
    // clear the form items we don't want to show and show a message.
    if (!empty($results) && !in_array('administrator', $account->roles)) {
      $form['inope_policy_review_status_radio'] = array();
      $form['inope_policy_review_changes_requested_textarea'] = array();
      $form['inope_policy_review_submit'] = array();
      $form['message'] = array(
        '#type' => 'markup',
        '#markup' => t('Thank you for your feedback!
        Please check back often for additional review.'),
      );
    }
  }
}

/**
 * The iNope Policy Review Form.
 */
function inope_policy_review_form($form, &$form_state, $node) {
  global $user;

  $account = $user;

  // Create radio button options (approved or changes requested).
  $status = array(
    0 => t('I have reviewed this policy and approved it for use'),
    1 => t('I have reviewed this policy and would like to see changes'),
  );

  // Build the radio button.
  $form['inope_policy_review_status_radio'] = array(
    '#type' => 'radios',
    '#options' => $status,
    '#default_value' => 0,
  );

  // Create text area for feedback on changes requested option only.
  // Also, only required when the changes requested option is selected.
  $form['inope_policy_review_changes_requested_textarea'] = array(
    '#type' => 'textarea',
    '#title' => t('Changes Requested:'),
    '#default_value' => '',
    '#states' => array(
      'invisible' => array(
        ':input[name="inope_policy_review_status_radio"]' => array('value' => 0),
      ),
      'visible' => array(
        ':input[name="inope_policy_review_status_radio"]' => array('value' => 1),
      ),
      'required' => array(
        ':input[name="inope_policy_review_status_radio"]' => array('value' => 1),
      ),
    ),
  );

  // Store argument from the autoloader in hook_menu().
  $node = $form_state['build_info']['args'][0];

  // Store the nid for future use, not displayed to the user.
  $form['inope_policy_review_hidden_nid'] = array(
    '#type' => 'hidden',
    '#value' => $node->nid,
  );

  // Store the vid for future use, not displayed to the user.
  $form['inope_policy_review_hidden_vid'] = array(
    '#type' => 'hidden',
    '#value' => $node->vid,
  );

  // Store the uid for future use, not displayed to the user.
  $form['inope_policy_review_hidden_uid'] = array(
    '#type' => 'hidden',
    '#value' => $account->uid,
  );

  // Create the submit button.
  $form['inope_policy_review_submit'] = array(
    '#type' => 'submit',
    '#value' => t('Submit'),
  );

  return $form;
}

/**
 * The iNope Policy Review Form submit handler.
 */
function inope_policy_review_form_submit($form, &$form_state) {
  // Load objects from which their properties will be displayed.
  $account = user_load($form_state['values']['inope_policy_review_hidden_uid']);
  $node = node_load($form_state['values']['inope_policy_review_hidden_nid']);

  // If 'I have reviewed this policy and approved it for use' is selected.
  if ($form_state['values']['inope_policy_review_status_radio'] == 0) {

    // Only administrators should be able to approve notes.
    if (in_array('administrator', $account->roles)) {

      // Run an update query on the policy review table to set the note_status
      // as approved where the fields are equal to the current node and are
      // unapproved.
      $updated_records = db_update('policy_review')
        ->fields(array(
          'note_status' => 1,
        ))
        ->condition('nid', $node->nid, '=')
        ->condition('note_status', 0, '=')
        ->execute();

      drupal_set_message(t('Policy approved for use @number records updated', array(
        '@number' => $updated_records,
      )));
    }
    // Staff will receive this warning message.
    else {
      drupal_set_message(t('Please contact your administrator for approval.'),
        'warning');
    }

  }
  // If 'I have reviewed this policy and would like to see changes' is selected.
  elseif ($form_state['values']['inope_policy_review_status_radio'] == 1) {

    // Make code more legible by setting a variable here.
    $text = $form_state['values']['inope_policy_review_changes_requested_textarea'];

    // Run an insert query on the policy review table for the new note.
    $policy_review_id = db_insert('policy_review')
      ->fields(array(
        'nid' => $node->nid,
        'vid' => $node->vid,
        'uid' => $account->uid,
        'note_status' => 0,
        'note_submitted' => time(),
        'note' => $text,
      ))
      ->execute();

    // Thank the user for their request.
    drupal_set_message(
      t('Thank you @username for submitting the following change request:', array(
        '@username' => $account->name,
      )));

    drupal_set_message($text);
  }
  // If a bug is encountered.
  else {
    drupal_set_message(t('Form state not recognized'));
  }

  // Rebuild the form.
  $form_state['rebuild'] = TRUE;
}
